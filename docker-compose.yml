services:
  # ==================== INFRASTRUCTURE ====================
  traefik:
    image: traefik:v2.10
    command:
      - --configFile=/etc/traefik/traefik.yml
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik:ro
    networks:
      - webmesh-network

  postgresql-service:
    image: postgres:15
    container_name: postgresql-service
    environment:
      - POSTGRES_DB=telemetry_db
      - POSTGRES_USER=telemetry_user
      - POSTGRES_PASSWORD=telemetry_password
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - webmesh-network
    labels:
      - "traefik.enable=false"

  # ==================== UNIFIED DATA SERVICE ====================
  data-service:
    build:
      context: .
      dockerfile: data-service/Dockerfile
    container_name: data-service
    ports:
      - "8004:8004"
    environment:
      - DATABASE_URL=postgresql://telemetry_user:telemetry_password@postgresql-service:5432/telemetry_db
      - SECRET_KEY=your-jwt-secret-key-change-in-production
    networks:
      - webmesh-network
    depends_on:
      - postgresql-service
    labels:
      - "traefik.enable=true"
      
      # Sessions endpoints
      - "traefik.http.routers.data-service-sessions.entrypoints=web"
      - "traefik.http.routers.data-service-sessions.rule=PathPrefix(`/api/sessions`)"
      - "traefik.http.routers.data-service-sessions.service=data-service"
      - "traefik.http.routers.data-service-sessions.middlewares=auth-forward@file,cors@file"
      
      # Table endpoints  
      - "traefik.http.routers.data-service-table.entrypoints=web"
      - "traefik.http.routers.data-service-table.rule=PathPrefix(`/api/table`)"
      - "traefik.http.routers.data-service-table.service=data-service"
      - "traefik.http.routers.data-service-table.middlewares=auth-forward@file,cors@file"
      
      # Modules endpoints
      - "traefik.http.routers.data-service-modules.entrypoints=web"
      - "traefik.http.routers.data-service-modules.rule=PathPrefix(`/api/modules`)"
      - "traefik.http.routers.data-service-modules.service=data-service"
      - "traefik.http.routers.data-service-modules.middlewares=auth-forward@file,cors@file"
      
      # Database endpoints
      - "traefik.http.routers.data-service-database.entrypoints=web"
      - "traefik.http.routers.data-service-database.rule=PathPrefix(`/api/database`)"
      - "traefik.http.routers.data-service-database.service=data-service"
      - "traefik.http.routers.data-service-database.middlewares=auth-forward@file,cors@file"
      
      # Data endpoints
      - "traefik.http.routers.data-service-data.entrypoints=web"
      - "traefik.http.routers.data-service-data.rule=PathPrefix(`/api/data`)"
      - "traefik.http.routers.data-service-data.service=data-service"
      - "traefik.http.routers.data-service-data.middlewares=auth-forward@file,cors@file"
      
      # Users endpoints
      - "traefik.http.routers.data-service-users.entrypoints=web"
      - "traefik.http.routers.data-service-users.rule=PathPrefix(`/api/users`)"
      - "traefik.http.routers.data-service-users.service=data-service"
      - "traefik.http.routers.data-service-users.middlewares=auth-forward@file,cors@file"

      # Users endpoints (для внутренней аутентификации)
      - "traefik.http.routers.data-service-local.entrypoints=web"
      - "traefik.http.routers.data-service-local.rule=PathPrefix(`/users`) || PathPrefix(`/auth/authenticate`)"
      - "traefik.http.routers.data-service-local.service=data-service"
      - "traefik.http.routers.data-service-local.middlewares=cors@file"
      
      # Service definition
      - "traefik.http.services.data-service.loadbalancer.server.port=8004"
      
  # ==================== SECURITY & AUTH ====================
  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth-service
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=postgresql://telemetry_user:telemetry_password@postgresql-service:5432/telemetry_db
      - SECRET_KEY=your-jwt-secret-key-change-in-production
    networks:
      - webmesh-network
    depends_on:
      - postgresql-service
      - data-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-service.entrypoints=web"
      - "traefik.http.routers.auth-service.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.services.auth-service.loadbalancer.server.port=8003"
      - "traefik.http.routers.auth-service.middlewares=cors@file"

  # ==================== FRONTEND (ЧИСТАЯ СТАТИКА) ====================
  frontend-service:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: frontend-service
    networks:
      - webmesh-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`) && !PathPrefix(`/api/`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=5000"
      - "traefik.http.routers.frontend.middlewares=cors@file"

networks:
  webmesh-network:
    driver: bridge
