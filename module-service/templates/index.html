<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP Server Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { background: white; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .connected { color: green; }
        .disconnected { color: red; }
        .log-entry { margin-bottom: 5px; padding: 5px; border-left: 3px solid #007bff; }
        .log-warning { border-left-color: #ffc107; }
        .log-error { border-left-color: #dc3545; }
        .log-debug { border-left-color: #6c757d; }
        .message-list { max-height: 400px; overflow-y: auto; }
        .send-form { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .send-form input, .send-form select, .send-form button { padding: 8px; }
        .send-form input { flex: 2; }
        .send-form select { flex: 1; }
        .tab-buttons { display: flex; margin-bottom: 10px; }
        .tab-button { padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; cursor: pointer; }
        .tab-button.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .consumer { background-color: #e8f5e8; }
        .provider { background-color: #e8f0ff; }
        .active-connection { font-weight: bold; }
        .port-info { font-size: 0.8em; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TCP Server Monitor</h1>
        
        <div class="stats" id="stats">
            <!-- Stats will be loaded via JavaScript -->
        </div>
        
        <div class="section">
            <h2>Connected Modules</h2>
            <div id="connectedModules">
                <!-- Module list will be loaded via JavaScript -->
            </div>
        </div>
        
        <div class="section">
            <h2>Send Messages</h2>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('consumerTab')">To Consumers</button>
                <button class="tab-button" onclick="showTab('providerTab')">To Providers</button>
            </div>
            
            <div id="consumerTab" class="tab-content active">
                <div class="send-form">
                    <input type="text" id="consumerMessageInput" placeholder="Enter message (text or HEX like 1c 2c3c 4c)...">
                        <select id="consumerModuleSelect">
                            <option value="">Select consumer...</option>
                        </select>
                        <select id="messageFormat">
                            <option value="text">Text</option>
                            <option value="hex">HEX</option>
                        </select>
                        <button onclick="sendToConsumer()">Send to Consumer</button>
                </div>
            </div>
            
            <div id="providerTab" class="tab-content">
                <div class="send-form">
                    <input type="text" id="providerMessageInput" placeholder="Enter message for provider...">
                    <select id="providerModuleSelect">
                        <option value="">Select provider...</option>
                    </select>
                    <button onclick="sendToProvider()">Send to Provider</button>
                </div>
                <p><small>Note: sending works only for active connected providers</small></p>
            </div>
            
            <div id="sendStatus"></div>
        </div>
        
        <div class="section">
            <h2>Sent Messages</h2>
            <div class="message-list" id="sentMessages">
                <!-- Sent messages list -->
            </div>
        </div>
        
        <div class="section">
            <h2>All Messages (Logs)</h2>
            <div class="message-list" id="allMessages">
                <!-- All messages will be loaded via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'consumerTab';
        let selectedConsumer = '';
        let selectedProvider = '';
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
        }
        
        function loadStats() {
            fetch('/api/server_status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('stats').innerHTML = `
                        <div class="stat-card">
                            <h3>Connected Consumers</h3>
                            <p style="font-size: 24px; color: green;">${data.connected_consumers}</p>
                            <p class="port-info">Port 5002</p>
                        </div>
                        <div class="stat-card">
                            <h3>Connected Providers</h3>
                            <p style="font-size: 24px; color: purple;">${data.connected_providers}</p>
                            <p class="port-info">Port 5000</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Messages</h3>
                            <p style="font-size: 24px; color: blue;">${data.total_messages}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Sent Messages</h3>
                            <p style="font-size: 24px; color: orange;">${data.sent_messages}</p>
                        </div>
                        <div class="stat-card">
                            <h3>Server Time</h3>
                            <p>${data.server_time}</p>
                            <p class="port-info">Web Port 5001</p>
                        </div>
                    `;
                });
        }
        
        function loadConnectedModules() {
            // Save current selected values
            const consumerSelect = document.getElementById('consumerModuleSelect');
            const providerSelect = document.getElementById('providerModuleSelect');
            selectedConsumer = consumerSelect.value;
            selectedProvider = providerSelect.value;
            
            fetch('/api/connected_modules')
                .then(response => response.json())
                .then(modules => {
                    const modulesDiv = document.getElementById('connectedModules');
                    
                    if (modules.length === 0) {
                        modulesDiv.innerHTML = '<p>No connected modules</p>';
                        consumerSelect.innerHTML = '<option value="">Select consumer...</option>';
                        providerSelect.innerHTML = '<option value="">Select provider...</option>';
                        return;
                    }
                    
                    let html = '<table><tr><th>Type</th><th>UUID</th><th>Address</th><th>Port</th><th>Status</th><th>Last Activity</th></tr>';
                    let consumerOptions = '<option value="">Select consumer...</option>';
                    let providerOptions = '<option value="">Select provider...</option>';
                    
                    modules.forEach(module => {
                        const statusClass = module.status === 'connected' ? 'connected' : 'disconnected';
                        const lastActivity = new Date(module.last_activity * 1000).toLocaleString();
                        const rowClass = module.type === 'consumer' ? 'consumer' : 'provider';
                        const connectionClass = module.status === 'connected' ? 'active-connection' : '';
                        
                        html += `<tr class="${rowClass}">
                            <td>${module.type}</td>
                            <td class="${connectionClass}">${module.uuid || 'N/A'}</td>
                            <td class="${connectionClass}">${module.address}</td>
                            <td>${module.port}</td>
                            <td class="${statusClass}">${module.status}</td>
                            <td>${lastActivity}</td>
                        </tr>`;
                        
                        if (module.type === 'consumer' && module.uuid) {
                            const selected = module.uuid === selectedConsumer ? 'selected' : '';
                            consumerOptions += `<option value="${module.uuid}" ${selected}>${module.uuid} (${module.address}) - ${module.status}</option>`;
                        } else if (module.type === 'provider') {
                            const selected = module.address === selectedProvider ? 'selected' : '';
                            providerOptions += `<option value="${module.address}" ${selected}>${module.address} - ${module.status}</option>`;
                        }
                    });
                    
                    html += '</table>';
                    modulesDiv.innerHTML = html;
                    consumerSelect.innerHTML = consumerOptions;
                    providerSelect.innerHTML = providerOptions;
                });
        }
        
        function loadSentMessages() {
            fetch('/api/sent_messages')
                .then(response => response.json())
                .then(messages => {
                    const sentMessagesDiv = document.getElementById('sentMessages');
                    
                    if (messages.length === 0) {
                        sentMessagesDiv.innerHTML = '<p>No sent messages</p>';
                        return;
                    }
                    
                    let html = '';
                    messages.slice().reverse().forEach(msg => {
                        const direction = msg.direction || 'outgoing';
                        const directionText = direction === 'manual_to_provider' ? 'MANUAL->PROVIDER' : 
                                            direction === 'manual_to_consumer' ? 'MANUAL->CONSUMER' : 
                                            direction === 'manual' ? 'MANUAL' : 'AUTOMATIC';
                        
                        html += `<div class="log-entry">
                            <strong>[${msg.timestamp}]</strong> 
                            ${msg.to_uuid ? `UUID: ${msg.to_uuid}` : ''}
                            ${msg.to_address ? `ADDRESS: ${msg.to_address}` : ''}
                            <strong>${msg.message}</strong>
                            <em>(${directionText})</em>
                        </div>`;
                    });
                    
                    sentMessagesDiv.innerHTML = html;
                });
        }
        
        function loadAllMessages() {
            fetch('/api/all_messages')
                .then(response => response.json())
                .then(messages => {
                    const allMessagesDiv = document.getElementById('allMessages');
                    
                    if (messages.length === 0) {
                        allMessagesDiv.innerHTML = '<p>No messages</p>';
                        return;
                    }
                    
                    let html = '';
                    messages.slice().reverse().forEach(msg => {
                        const levelClass = msg.level === 'WARNING' ? 'log-warning' : 
                                         msg.level === 'ERROR' ? 'log-error' : 
                                         msg.level === 'DEBUG' ? 'log-debug' : '';
                        
                        html += `<div class="log-entry ${levelClass}">
                            <strong>[${msg.timestamp}] [${msg.level}]</strong> 
                            ${msg.module ? `Module: ${msg.module} - ` : ''}
                            ${msg.message}
                        </div>`;
                    });
                    
                    allMessagesDiv.innerHTML = html;
                });
        }
        
        function sendToConsumer() {
            const message = document.getElementById('consumerMessageInput').value;
            const uuid = document.getElementById('consumerModuleSelect').value;
            const format = document.getElementById('messageFormat').value;

            if (!message || !uuid) {
                document.getElementById('sendStatus').innerHTML = '<p style="color: red;">Fill all fields</p>';
                return;
            }

            fetch('/api/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uuid: uuid, message: message, format: format })
            })
            .then(response => response.json())
            .then(result => {
                const statusDiv = document.getElementById('sendStatus');
                if (result.status === 'success') {
                    statusDiv.innerHTML = '<p style="color: green;">Message sent to consumer</p>';
                    document.getElementById('consumerMessageInput').value = '';
                    loadSentMessages();
                    loadAllMessages();
                } else {
                    statusDiv.innerHTML = `<p style="color: red;">Error: ${result.message}</p>`;
                }
            });
        }
        
        function sendToProvider() {
            const message = document.getElementById('providerMessageInput').value;
            const address = document.getElementById('providerModuleSelect').value;
            
            if (!message || !address) {
                document.getElementById('sendStatus').innerHTML = '<p style="color: red;">Fill all fields</p>';
                return;
            }
            
            fetch('/api/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: address, message: message })
            })
            .then(response => response.json())
            .then(result => {
                const statusDiv = document.getElementById('sendStatus');
                if (result.status === 'success') {
                    statusDiv.innerHTML = '<p style="color: green;">Message sent to provider</p>';
                    document.getElementById('providerMessageInput').value = '';
                    loadSentMessages();
                    loadAllMessages();
                } else {
                    statusDiv.innerHTML = `<p style="color: red;">Error: ${result.message}</p>`;
                }
            });
        }
        
        // Auto update every 2 seconds
        function updateAll() {
            loadStats();
            loadConnectedModules();
            loadSentMessages();
            loadAllMessages();
        }
        
        // Initial load
        updateAll();
        
        // Update every 2 seconds
        setInterval(updateAll, 2000);
    </script>
</body>
</html>